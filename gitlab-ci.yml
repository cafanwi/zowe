stages:
  - build

variables:
  ARTIFACTORY_REGISTRY: https://your-artifactory-url/artifactory
  ARTIFACTORY_REPO: docker-repo
  ARTIFACTORY_USERNAME: your-artifactory-username
  ARTIFACTORY_PASSWORD: your-artifactory-password

build:
  stage: build
  image: docker:20.10.7
  services:
    - docker:20.10.7-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build --build-arg ARTIFACTORY_REGISTRY=$ARTIFACTORY_REGISTRY \
                   --build-arg ARTIFACTORY_REPO=$ARTIFACTORY_REPO \
                   --build-arg ARTIFACTORY_USERNAME=$ARTIFACTORY_USERNAME \
                   --build-arg ARTIFACTORY_PASSWORD=$ARTIFACTORY_PASSWORD \
                   -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $ARTIFACTORY_REGISTRY/$ARTIFACTORY_REPO/zowe-image:latest
    - docker push $ARTIFACTORY_REGISTRY/$ARTIFACTORY_REPO/zowe-image:latest
